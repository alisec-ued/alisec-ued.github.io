<!DOCTYPE html><html><head><meta charset="utf-8"><meta name="X-UA-Compatible" content="IE=edge"><title> 图解Redux数据流(二) · Hexo</title><meta name="description" content="图解Redux数据流(二) - alisec-ued"><meta name="viewport" content="width=device-width, initial-scale=1"><link rel="short icon" href="/favicon.png"><link rel="stylesheet" href="/css/apollo.css"><link rel="search" type="application/opensearchdescription+xml" href="https://alisec-ued.github.io/atom.xml" title="Hexo"></head><body><div class="wrap"><header><a href="/" class="logo-link"><img src="/favicon.png"></a><ul class="nav nav-list"><li class="nav-list-item"><a href="/" target="_self" class="nav-list-link">BLOG</a></li><li class="nav-list-item"><a href="/archives/" target="_self" class="nav-list-link">ARCHIVE</a></li><li class="nav-list-item"><a href="https://github.com/alisec-ued" target="_blank" class="nav-list-link">GITHUB</a></li><li class="nav-list-item"><a href="/atom.xml" target="_self" class="nav-list-link">RSS</a></li></ul></header><section class="container"><div class="post"><article class="post-block"><h1 class="post-title">图解Redux数据流(二)</h1><div class="post-info">Nov 28, 2016</div><div class="post-content"><p>上一篇文章回答了前两个问题，而这一篇则回答最后一个问题。</p>
<h2 id="Redux如何使用？"><a href="#Redux如何使用？" class="headerlink" title="Redux如何使用？"></a>Redux如何使用？</h2><p>前一篇文章描述了Redux的基本要素，并且梳理了一下Redux的数据流动图</p>
<p><img src="https://img.alicdn.com/tps/TB1vRLKOpXXXXacaXXXXXXXXXXX-889-271.png" alt="Alt text"></p>
<p>首先，我们的View上体现出的任何操作或者事件都会调用Dispatch方法触发Action<br>Action 会告知了type和data<br>然后，Store自动调用Reducer，并且传入两个参数：当前 State和收到的Action。 Reducer会返回新的State 。并且这个过程是纯函数式的，返回的结果由入参决定，不会随着外界的变化而改变。</p>
<p>知道概念了，那么我们从代码层面如何搭建出Redux数据流的架构呢？</p>
<a id="more"></a>
<h3 id="最基本的Redux数据流"><a href="#最基本的Redux数据流" class="headerlink" title="最基本的Redux数据流"></a>最基本的Redux数据流</h3><figure class="highlight javascript"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div></pre></td><td class="code"><pre><div class="line"></div><div class="line"><span class="keyword">import</span> &#123; createStore &#125; <span class="keyword">from</span> <span class="string">'redux'</span>;</div><div class="line"></div><div class="line"><span class="keyword">const</span> initialState = &#123;</div><div class="line">  	<span class="attr">items</span>: []</div><div class="line">&#125;;</div><div class="line"></div><div class="line"><span class="keyword">const</span> reducer = <span class="function">(<span class="params">state = initialState, action = &#123;&#125;</span>) =&gt;</span> &#123;  </div><div class="line"><span class="keyword">const</span> &#123; type &#125; = action;</div><div class="line"><span class="keyword">switch</span> (type) &#123;</div><div class="line">    <span class="keyword">case</span> <span class="string">"ADD_ITEM"</span>:</div><div class="line">      <span class="keyword">return</span> <span class="built_in">Object</span>.assign(&#123;&#125;, state, &#123;</div><div class="line">        <span class="attr">items</span>: state.items.concat(action.item)</div><div class="line">      &#125;);</div><div class="line">      <span class="keyword">break</span>;</div><div class="line">    <span class="keyword">case</span> <span class="string">"GET_ITEM_LIST"</span>:</div><div class="line">      <span class="keyword">return</span> <span class="built_in">Object</span>.assign(&#123;&#125;, state, &#123;</div><div class="line">        <span class="attr">items</span>: action.items</div><div class="line">      &#125;);</div><div class="line">      <span class="keyword">break</span>;</div><div class="line">  &#125;</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="keyword">const</span> store = createStore(reducer)</div><div class="line"></div><div class="line">store.subscribe(<span class="function"><span class="params">()</span> =&gt;</span> &#123;</div><div class="line">  <span class="built_in">console</span>.log(store.getState())</div><div class="line">&#125;)</div><div class="line"></div><div class="line">store.dispatch(&#123;<span class="attr">type</span>: <span class="string">'GET_ITEM_LIST'</span>,<span class="string">'items'</span>:[&#123;<span class="attr">id</span>:<span class="number">1</span>,<span class="attr">name</span>:<span class="string">'test'</span>&#125;]&#125;)</div><div class="line">store.dispatch(&#123;<span class="attr">type</span>: <span class="string">'ADD_ITEM'</span>,<span class="string">'item'</span>:[&#123;<span class="attr">id</span>:<span class="number">2</span>,<span class="attr">name</span>:<span class="string">'test2'</span>&#125;]&#125;)</div><div class="line"></div></pre></td></tr></table></figure>
<p>这个代码段是最简单的Redux数据流例子，把创建Store、ActionCreator、Reducer全放在了一个文件中，在实际项目中，这当然不可取。<br>其实每个Redux的实体概念都可以拆解成一个单独的文件去管理。<br>在项目中为了项目的规范化，我们可以对所有的action_type常量进行统一的管理，放到单独的文件中</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line"></div><div class="line"><span class="keyword">const</span> GET_ITEM_LIST = <span class="string">'GET_ITEM_LIST'</span></div><div class="line"><span class="keyword">const</span> ADD_ITEM = <span class="string">'ADD_ITEM'</span></div><div class="line"></div></pre></td></tr></table></figure>
<p>当然，也许最需要进行拆分是Reducer，在有些规模的实际项目中，state往往比较庞大。对于Reducer而言，我们最好根据相应的业务需求拆分出不同Reducer来管理。</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div></pre></td><td class="code"><pre><div class="line"></div><div class="line"><span class="keyword">import</span> &#123; createStore,combineReducers &#125; <span class="keyword">from</span> <span class="string">'redux'</span>;</div><div class="line"><span class="keyword">const</span> itemReducer = <span class="function">(<span class="params">state = &#123;&#125;, action = &#123;&#125;</span>) =&gt;</span> &#123;  </div><div class="line">	<span class="keyword">const</span> &#123; type &#125; = action;</div><div class="line">	<span class="keyword">switch</span> (type) &#123;</div><div class="line">	    <span class="keyword">case</span> <span class="string">"ADD_ITEM"</span>:</div><div class="line">	      <span class="keyword">return</span> &#123;</div><div class="line">		      ...state,</div><div class="line">		      <span class="attr">items</span>: state.items.concat(action.item)</div><div class="line">		  &#125;</div><div class="line">	      <span class="keyword">break</span>;</div><div class="line">	    <span class="keyword">case</span> <span class="string">"DELETE_ITEM"</span>:</div><div class="line">	      <span class="keyword">return</span> &#123;</div><div class="line">		      ...state,</div><div class="line">		      <span class="attr">items</span>: state.items.filter(<span class="function">(<span class="params">item</span>)=&gt;</span> &#123;</div><div class="line">		        <span class="keyword">return</span> !(item.id === action.itemId);</div><div class="line">		      &#125;)</div><div class="line">		  &#125;</div><div class="line">		  <span class="keyword">break</span>;</div><div class="line">	  &#125;</div><div class="line">	&#125;</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="keyword">const</span> ListReducer = <span class="function">(<span class="params">state = &#123;items: []&#125;, action</span>) =&gt;</span> &#123;</div><div class="line">    <span class="keyword">const</span> &#123; type &#125; = action;</div><div class="line">	<span class="keyword">switch</span> (type) &#123;</div><div class="line">	    <span class="keyword">case</span> <span class="string">"GET_ITEM_LIST"</span>:</div><div class="line">		  <span class="keyword">return</span> &#123;</div><div class="line">		      ...state,</div><div class="line">		      <span class="attr">items</span>: action.items</div><div class="line">		  &#125;</div><div class="line">		  <span class="keyword">break</span>;</div><div class="line">	    <span class="keyword">case</span> <span class="string">"CLEAR_ITEM_LIST"</span>:</div><div class="line">	      <span class="keyword">return</span> &#123;</div><div class="line">		      ...state,</div><div class="line">		      <span class="attr">items</span>: []</div><div class="line">		  &#125;</div><div class="line">		  <span class="keyword">break</span>;</div><div class="line">	  &#125;</div><div class="line">	&#125;</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="keyword">const</span> reducer = combineReducers(&#123;itemReducer,ListReducer&#125;)</div><div class="line"></div></pre></td></tr></table></figure>
<p>可以看到，Redux其实本身也提供了combineReducers方法来帮助开发者合并Reducer，可以让每个Reducer互相独立。</p>
<h3 id="Middleware中间件"><a href="#Middleware中间件" class="headerlink" title="Middleware中间件"></a>Middleware中间件</h3><p>Redux中，一切数据都是从一个状态到另一个状态，那么也许我们需要在这个状态间添加一些自己的方法或者功能呢？<br>这个时候就需要Middleware，Middleware发生在发送Action时，也就是调用store.dispatch()。<br>在Middleware中，我们通过调用next(action)函数就可以把Action传递给Reducer。<br>例如一个典型的简易版redux-logger模块，</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div></pre></td><td class="code"><pre><div class="line"></div><div class="line"><span class="keyword">import</span> &#123; createStore, applyMiddleware &#125; <span class="keyword">from</span> <span class="string">'redux'</span>;</div><div class="line"></div><div class="line"><span class="keyword">const</span> initialState = &#123;</div><div class="line">  	<span class="attr">items</span>: []</div><div class="line">&#125;;</div><div class="line"></div><div class="line"><span class="keyword">const</span> reducer = <span class="function">(<span class="params">state = initialState, action = &#123;&#125;</span>) =&gt;</span> &#123;  </div><div class="line"><span class="keyword">const</span> &#123; type &#125; = action;</div><div class="line"><span class="keyword">switch</span> (type) &#123;</div><div class="line">    <span class="keyword">case</span> <span class="string">"ADD_ITEM"</span>:</div><div class="line">      <span class="keyword">return</span> &#123;</div><div class="line">	     ...state,</div><div class="line">	      <span class="attr">items</span>: state.items.concat(action.item)</div><div class="line">	  &#125;</div><div class="line">      <span class="keyword">break</span>;</div><div class="line">    <span class="keyword">case</span> <span class="string">"GET_ITEM_LIST"</span>:</div><div class="line">      <span class="keyword">return</span> &#123;</div><div class="line">	     ...state,</div><div class="line">	      <span class="attr">items</span>: action.items</div><div class="line">	  &#125;</div><div class="line">      <span class="keyword">break</span>;</div><div class="line">  &#125;</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="keyword">const</span> reduxlog = <span class="function"><span class="params">store</span> =&gt;</span> next =&gt; <span class="function"><span class="params">action</span> =&gt;</span> &#123;</div><div class="line">  <span class="built_in">console</span>.log(<span class="string">`prev state`</span>, store.getState())</div><div class="line">  <span class="built_in">console</span>.log(<span class="string">`action:`</span>, action.type)</div><div class="line">  next(action)</div><div class="line">  <span class="built_in">console</span>.log(<span class="string">`next state`</span>,store.getState())</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="keyword">const</span> store = createStore(reducer, initialState, applyMiddleware(reduxlog))</div><div class="line"></div><div class="line">store.subscribe(<span class="function"><span class="params">()</span> =&gt;</span> &#123;</div><div class="line">  <span class="built_in">console</span>.log(store.getState())</div><div class="line">&#125;)</div><div class="line"></div><div class="line">store.dispatch(&#123;<span class="attr">type</span>: <span class="string">'GET_ITEM_LIST'</span>,<span class="string">'items'</span>:[&#123;<span class="attr">id</span>:<span class="number">1</span>,<span class="attr">name</span>:<span class="string">'test'</span>&#125;]&#125;)</div><div class="line">store.dispatch(&#123;<span class="attr">type</span>: <span class="string">'ADD_ITEM'</span>,<span class="string">'item'</span>:[&#123;<span class="attr">id</span>:<span class="number">2</span>,<span class="attr">name</span>:<span class="string">'test2'</span>&#125;]&#125;)</div><div class="line"></div></pre></td></tr></table></figure>
<p><img src="https://img.alicdn.com/tps/TB1j2nuOpXXXXXTapXXXXXXXXXX-840-260.png" alt="Alt text"></p>
<p>中间件处理了改变前和改变后的状态，写法也非常容易理解，如果有业务需要对状态集中处理，通过中间件的方式也不失为一种选择。<br>文章头部的那张图，如果加上中间件，就是这样：</p>
<p><img src="https://img.alicdn.com/tps/TB1BEr9OpXXXXbnXXXXXXXXXXXX-889-287.png" alt="Alt text"></p>
<h3 id="中间件的顺序"><a href="#中间件的顺序" class="headerlink" title="中间件的顺序"></a>中间件的顺序</h3><figure class="highlight javascript"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line"></div><div class="line"><span class="keyword">const</span> store = createStore(</div><div class="line">  reducer,</div><div class="line">  applyMiddleware(thunk, promise, logger)</div><div class="line">);</div><div class="line"></div></pre></td></tr></table></figure>
<p>中间件的调用顺序其实还是有一定讲究，这就要从Middleware本身的设计思想来说明。<br>Redux深受函数式编程的影响，中间件的设计也不例外，</p>
<blockquote>
<p>middleware 的设计有点特殊，是一个层层包裹的匿名函数，这其实是函数式编程中的柯里化 curry，一种使用匿名单参数函数来实现多参数函数的方法。applyMiddleware 会对 logger 这个 middleware 进行层层调用，动态地对 store 和 next 参数赋值。</p>
</blockquote>
<p>Redux的applyMiddleware会将所有的中间件组合串联，</p>
<blockquote>
<p>compose 将 chain 中的所有匿名函数，[f1, f2, … , fx, …, fn]，组装成一个新的函数，即新的 dispatch，当新 dispatch 执行时，[f1, f2, … , fx, …, fn]，从左到右依次执行（ 所以顺序很重要）</p>
</blockquote>
<p>具体中间件的实现思路不详细展开，知乎上有一篇专栏分析的很到位，有兴趣可以看一下 <a href="https://zhuanlan.zhihu.com/p/20597452#!" target="_blank" rel="external">链接</a></p>
<p>上面的例子里如果logger中间件不放置在最后面，输出结果会不正确。</p>
<h3 id="异步问题"><a href="#异步问题" class="headerlink" title="异步问题"></a>异步问题</h3><p>刚刚我们看了那么多示例代码？但是至此，Redux一直没有解决异步的问题。试想，如果我在页面输入一段内容，然后触发了一个动作，此时需要向服务端请求数据并将返回的数据展示出来。这是一个很常见的需求，但是涉及到异步请求，刚刚的示例中的方法已经不再适用了。那么Redux是如何解决异步问题的呢？</p>
<p>没错，还是<strong>Middleware</strong>，Middleware只关注dispatch函数的传递，至于在传递的过程中干了什么中间件并不关心。<br>这里不得不提<strong>redux-thunk</strong>这个中间件</p>
<p>redux-thunk的基本思想就是通过函数来封装异步请求，也就是说在actionCreater中返回一个函数，在这个函数中进行异步调用。</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div></pre></td><td class="code"><pre><div class="line"></div><div class="line"><span class="function"><span class="keyword">function</span> <span class="title">createThunkMiddleware</span>(<span class="params">extraArgument</span>) </span>&#123;</div><div class="line">  <span class="keyword">return</span> <span class="function">(<span class="params">&#123; dispatch, getState &#125;</span>) =&gt;</span> next =&gt; <span class="function"><span class="params">action</span> =&gt;</span> &#123;</div><div class="line">    <span class="keyword">if</span> (<span class="keyword">typeof</span> action === <span class="string">'function'</span>) &#123;</div><div class="line">      <span class="keyword">return</span> action(dispatch, getState, extraArgument);</div><div class="line">    &#125;</div><div class="line">    <span class="keyword">return</span> next(action);</div><div class="line">  &#125;;</div><div class="line">&#125;</div><div class="line"><span class="keyword">const</span> thunk = createThunkMiddleware();</div><div class="line">thunk.withExtraArgument = createThunkMiddleware;</div><div class="line"><span class="keyword">export</span> <span class="keyword">default</span> thunk;</div><div class="line"></div></pre></td></tr></table></figure>    
<p>其实打开redux-thunk的源码看一下，讲真代码量就十几行，那么这里做了什么处理呢？<br>其实关键的就一句代码</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line"></div><div class="line"><span class="keyword">if</span> (<span class="keyword">typeof</span> action === <span class="string">'function'</span>) &#123;</div><div class="line">      <span class="keyword">return</span> action(dispatch, getState, extraArgument);</div><div class="line"> &#125;</div><div class="line"></div></pre></td></tr></table></figure>         
<p>我们知道Action正常其实返回的是一个js对象，如果没有经过Middleware的处理，是不符合Redux逻辑，会抛出异常的，<strong>所以redux-thunk只做了一件事件</strong>，<strong>那就是让Action能够兼容 return 函数</strong>，redux-thunk内部再去消化掉这个函数。</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div></pre></td><td class="code"><pre><div class="line"></div><div class="line"><span class="function"><span class="keyword">function</span> <span class="title">actionCreate</span>(<span class="params"></span>) </span>&#123;</div><div class="line">    <span class="keyword">return</span> <span class="function"><span class="keyword">function</span> (<span class="params">dispatch, getState</span>) </span>&#123;</div><div class="line">        api.fetch(data).then(<span class="function"><span class="keyword">function</span> (<span class="params">json</span>) </span>&#123;</div><div class="line">            dispatch(json);</div><div class="line">        &#125;)</div><div class="line">    &#125;</div><div class="line">&#125;</div><div class="line"></div></pre></td></tr></table></figure>    
<h3 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h3><p>以上是最近一段时间通过在业务不断实践，然后学习和思考的总结。</p>
<p>在这期间发现，很多东西需要事先去积累，要拓宽自己的视野，如果自己不知道某种设计思路并且没有相关经验时，很难想到点上。</p>
<p>技术与业务是相辅相成的，技术能够很好的帮助自己拓宽视野，能设计更好的项目架构；而业务能够让技术得以实践，并且发现技术上可能还存在的问题，从而积累经验。</p>
<p>这个思路我通过这段时间的学习感悟到的，今后的学习也会沿着这个思路走下去。</p>
</div></article></div></section><footer><div class="paginator"><a href="/2016/12/02/flex布局/" class="prev">PREV</a><a href="/2016/11/23/图解Redux数据流(一)/" class="next">NEXT</a></div><style>.ds-powered-by, .ds-comments-tab-weibo {
    display: none !important;
}</style><div data-thread-key="2016/11/28/图解Redux数据流(二)/" data-title="图解Redux数据流(二)" data-url="https://alisec-ued.github.io/2016/11/28/图解Redux数据流(二)/" data-author-key="1" class="ds-thread"></div><script>var duoshuoQuery = {short_name:"alisec-ued"};
(function() {
    var ds = document.createElement('script');
    ds.type = 'text/javascript';ds.async = true;
    ds.src = (document.location.protocol == 'https:' ? 'https:' : 'http:') + '//static.duoshuo.com/embed.js';
    ds.charset = 'UTF-8';
    (document.getElementsByTagName('head')[0] 
     || document.getElementsByTagName('body')[0]).appendChild(ds);
})();

</script><div class="copyright"><p>© 2016 <a href="https://alisec-ued.github.io">alisec-ued</a>, powered by <a href="https://hexo.io/" target="_blank">Hexo</a></p></div></footer></div><script async src="//cdn.bootcss.com/mathjax/2.6.1/MathJax.js?config=TeX-MML-AM_CHTML"></script><script>var _hmt = _hmt || []; (function() {var hm = document.createElement("script");hm.src = "https://hm.baidu.com/hm.js?f356a2d337ba7259fc3c8223ad3deeac";var s = document.getElementsByTagName("script")[0]; s.parentNode.insertBefore(hm, s);})();</script></body></html>